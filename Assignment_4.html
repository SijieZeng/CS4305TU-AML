<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head></head><body>















    






    
    
    
    


<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><img src="javascript://" alt="tud_logo.jpg"/></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h1>Assignment 4 - ML Ethical and Societal perspective<a rel="noopener" class="anchor-link" href="#Assignment-4---ML-Ethical-and-Societal-perspective">&#182;</a></h1><p>Week 4 - CS4305TU Applied Machine Learning <br/></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>By <b> Nadia Metoui </b> and <b> Ibo van de Poel </b><br/>
Faculty of Technology, Policy, and Management (TPM)</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><strong><em>Submission Instructions</em></strong></p>
<ul>
<li>Answer the questions (code or text) in this Notebook </li>
<li>Rename the Notebook by adding your group number</li>
<li>Send the your answers both in ipynb and HTML format</li>
</ul>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><h2>Part I: Socio-technical abstraction of an ML-based system</h2>
<i>LO-1: Identify and analyse ethical issues related to ML.<i><br/>
<i>LO-2: Discuss machine learning fairness in the broader context of sociotechnical systems.</i></i></i></p><i><i>

</i></i></div><i><i>
</i></i></div><i><i>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Q1: Analyse and discuss the potential harmes of an ML-based Recommendation System using the Taxonomy and Model of Milan et <i>al.</i> (2020).
To help with your analysis we provide 3 case studies you can find in Brightspace</p>
<ul>
<li>Tiktok recommendation systems (See Case Study 1)</li>
<li>Youtube recommendation systems (See Case Study 2)</li>
<li>Tinder recommendation systems (See Case Study 3)</li>
</ul>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Choose <b>one of the  Case Studies</b> above and answer the following questions based on your knowledge of the platform and the information you read on the case study:</p>
<ul>
<li>a) Briefly summarise, what seems to be the ethical/social issue tackled in the use case you selected. </li>
<li>b) Who are the stakeholdes in this case? Name and describe at lease one stakeholdes from each category? </li>
<li>c) Briefly explain what are the intrests of each stakeholde and value they derive from using the recommendation system.</li>
<li>d) Briefly explain what are the potential harmes for each stakeholde and how are they impacting them?</li>
</ul>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">
<b>Tip:</b> Consider all stakholders depicted in the figure below. Use the categorization of (Milano 2020).<br/>
The full paper as well as a cheatsheet can be found in Brightspace.
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><img src="javascript://" alt="milano_model-2.png"/></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">

<b>Types of Harm</b>
- <u>on Utility</u>: Utility is the value each party is expecting to derive from using a the ML-based system. The impact or harm to Utility can be assessed using quantifiable metrics (e.g., time, money)
- <u>on Rights</u>: legal, social, or ethical entitlements (e.g., privacy autonomy, equality)  The impact or harm to Ritghts is very hard to quantify.

<br/>

<b>Types of Impacts</b>
- <u>Immediate harm</u>: the recommendation or the ML-based system has an immediate and direct negative impact e.g., errors (incorrect outputs), out of context results (inappropriate outputs), opacity (uninterpretabel output).
- <u>Exposure to Risk</u>: the recommendation or the ML-based system exposes the Stakeholder(s) to latent or potential negative impacts. Even if these impacts do not materialize, exposure to such risks is considered unethical.
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<ul>
<li>Write your answers here you are free to add other cells if needed</li>
</ul>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/><br/></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><h2> Part II. Detecting and Mitigating bias*.</h2>
<i>LO-3: Apply state-of-the-art debiasing approaches to identify and mitigate risks of biases in your ML-based system.</i><br/>
<i>LO-4. Compare different implementations of fairness metrics and unfairness mitigation approaches.  
</i></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>*Acknowledgement: Part II of this assignment is largely based on the code developed by <i><b>Agathe Balayn</b></i> and <i><b>Seda G&#252;rses</b></i></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>In this part of the assignment, you will be exploring a use case where a Bank wants to develop an ML-based ADM (automate decision system) to decide whether to <b>grant</b> or <b>not to grant</b> a loan to a given applicant. To do so the Bank uses historical data containing multiple application records, characterized by information about the loan applicants (e.g., age, gender, personal situation) and information about the loan (e.g., amount, duration, purpose). Each application is labeled <i> good credit </i> if the loan had been reimbursed or <i>bad credit</i> if the loan has not been reimbursed or if there where several issues with the reimbursement.</p>
<p>To simulate this scenario we will build a classifier to disinguich between good and bad loans (or credits). We will train the classifier using the <i><b>German credit data</b></i> (you can information about the dataset and its attributes here: (<a rel="noopener" href="https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.doc">https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.doc</a>).<br/>
And you can download the dataset here:
<a rel="noopener" href="https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.data">https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.data</a><br/></p>
<p>You will be requested to take a closer look at the data and identify biases. We will use some tools form <i><b>AIF360 toolkit</b></i><br/>(<a rel="noopener" href="https://aif360.mybluemix.net/">https://aif360.mybluemix.net/</a>) a toolkit developed by IBM to detect and mitigate &quot;bias&quot; and &quot;unfairness&quot;.</p>
<p>Steps of Part II</p>
<ul>
<li>Step 1: Set-up (Provided)</li>
<li>Step 2: Explore and familiarize with the dataset</li>
<li>Step 3: Pre-processing Biases: Protected attributes, proxies, data representation and skews  </li>
<li>Step 4: In-processing Biases: Identify and Mitigate</li>
</ul>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Setp 2: Set-up</h3><p>You first need to install the required libraries for this part.  The main libraries are the <code>aif360</code>,  <code>lime</code>, and<code>sklearn</code> ones. We also recommend using <code>numpy</code> and <code>pandas</code> to easily manipulate and explore the data.</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-danger">
<b>Note:</b> Uncomment and run the next cell if you have not previously installed the libraries.
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Installing required libraries</b></p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># !pip install aif360</span>
<span class="c1"># !pip install fairlearn</span>
<span class="c1"># !pip install tensorflow</span>
<span class="c1"># !pip install lime</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Loading required libraries</b></p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">display</span>


<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">aif360.datasets</span> <span class="kn">import</span> <span class="n">GermanDataset</span>
<span class="kn">from</span> <span class="nn">aif360.metrics</span> <span class="kn">import</span> <span class="n">BinaryLabelDatasetMetric</span>
<span class="kn">from</span> <span class="nn">aif360.metrics</span> <span class="kn">import</span> <span class="n">ClassificationMetric</span>
<span class="kn">from</span> <span class="nn">aif360.algorithms.inprocessing</span> <span class="kn">import</span> <span class="n">MetaFairClassifier</span>

<span class="kn">from</span> <span class="nn">aif360.datasets.lime_encoder</span> <span class="kn">import</span> <span class="n">LimeEncoder</span>

<span class="kn">import</span> <span class="nn">lime</span>
<span class="kn">import</span> <span class="nn">lime.lime_tabular</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Loading the dataset</b></p>
<p>Here, we will load the <i><b>German credit data</b></i> in a format that is compatible with the use of the <i><b>AIF360 toolkit</b></i>. For this, you need to make use of the already implemented class of the toolkit <code>GermanDataset()</code>.</p>
<p>Because the data available is encoded in a complex way, we provide you with the code to preprocess it, in the function <code>custom_preprocessing()</code>. We also provide you with an example on how to actually load the data using the <code>GermanDataset()</code> class, in <code>preproc_and_load_data_german()</code>.</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">preproc_and_load_data_german</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and pre-process german credit dataset.</span>
<span class="sd">    Args: -</span>
<span class="sd">    Returns:</span>
<span class="sd">        GermanDataset: An instance of GermanDataset with required pre-processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">custom_preprocessing</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Custom pre-processing for German Credit Data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">group_credit_hist</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A30&#39;</span><span class="p">,</span> <span class="s1">&#39;A31&#39;</span><span class="p">,</span> <span class="s1">&#39;A32&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;None/Paid&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;A33&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Delay&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;A34&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Other&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NA&#39;</span>

        <span class="k">def</span> <span class="nf">group_employ</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;A71&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Unemployed&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A72&#39;</span><span class="p">,</span> <span class="s1">&#39;A73&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;1-4 years&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A74&#39;</span><span class="p">,</span> <span class="s1">&#39;A75&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;4+ years&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NA&#39;</span>

        <span class="k">def</span> <span class="nf">group_savings</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A61&#39;</span><span class="p">,</span> <span class="s1">&#39;A62&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;&lt;500&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A63&#39;</span><span class="p">,</span> <span class="s1">&#39;A64&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;500+&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;A65&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Unknown/None&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NA&#39;</span>

        <span class="k">def</span> <span class="nf">group_status</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A11&#39;</span><span class="p">,</span> <span class="s1">&#39;A12&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;&lt;200&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A13&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;200+&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;A14&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;None&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NA&#39;</span>
        
        <span class="k">def</span> <span class="nf">group_personal_status</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A91&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;divorced/separated&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A92&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;divorced/separated/married&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A93&#39;</span><span class="p">,</span> <span class="s1">&#39;A95&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;single&#39;</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A94&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;married/widowed&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NA&#39;</span>
        <span class="c1">#print(df)</span>
        <span class="c1">#print(df.shape)</span>
        <span class="c1">#print(df.isnull().sum().sum())</span>
        <span class="c1">#print(df.isin([&#39;NA&#39;]).sum(axis=0))</span>
        <span class="n">status_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A91&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;A93&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;A94&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s1">&#39;A92&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;A95&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;personal_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">status_map</span><span class="p">)</span>
        

        <span class="c1"># group credit history, savings, and employment</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;credit_history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;credit_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_credit_hist</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;savings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;savings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_savings</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;employment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;employment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_employ</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1">#df[&#39;age&#39;] = df[&#39;age&#39;].apply(lambda x: np.float(x &gt;= 26))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_status</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;personal_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;personal_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">group_personal_status</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1">#print(df.isin([&#39;NA&#39;]).sum(axis=0))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;german_credit_data_processed_v2.csv&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Feature partitions</span>
    <span class="n">XD_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;number_of_credits&#39;</span><span class="p">,</span> <span class="s1">&#39;telephone&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;foreign_worker&#39;</span><span class="p">,</span> <span class="s1">&#39;people_liable_for&#39;</span><span class="p">,</span> <span class="s1">&#39;skill_level&#39;</span><span class="p">,</span> <span class="s1">&#39;credit_history&#39;</span><span class="p">,</span> <span class="s1">&#39;installment_plans&#39;</span><span class="p">,</span> <span class="s1">&#39;residence_since&#39;</span><span class="p">,</span> <span class="s1">&#39;property&#39;</span><span class="p">,</span> <span class="s1">&#39;other_debtors&#39;</span><span class="p">,</span> <span class="s1">&#39;purpose&#39;</span><span class="p">,</span> <span class="s1">&#39;savings&#39;</span><span class="p">,</span> <span class="s1">&#39;employment&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;personal_status&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]</span>
    <span class="n">D_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">]</span> 
    <span class="n">Y_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;credit&#39;</span><span class="p">]</span>
    <span class="n">X_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">XD_features</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">D_features</span><span class="p">))</span>
    <span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;installment_plans&#39;</span><span class="p">,</span> <span class="s1">&#39;telephone&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;foreign_worker&#39;</span><span class="p">,</span> <span class="s1">&#39;skill_level&#39;</span><span class="p">,</span> <span class="s1">&#39;credit_history&#39;</span><span class="p">,</span> <span class="s1">&#39;property&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;other_debtors&#39;</span><span class="p">,</span> <span class="s1">&#39;purpose&#39;</span><span class="p">,</span> <span class="s1">&#39;savings&#39;</span><span class="p">,</span> <span class="s1">&#39;employment&#39;</span><span class="p">,</span> <span class="s1">&#39;personal_status&#39;</span><span class="p">]</span>

    <span class="c1"># privileged classes</span>
    <span class="n">all_privileged_classes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">],</span>
                              <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">}</span>

    <span class="c1"># protected attribute maps</span>
    <span class="n">all_protected_attribute_maps</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;Male&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">:</span> <span class="s1">&#39;Female&#39;</span><span class="p">},</span>
                                    <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;Old&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">:</span> <span class="s1">&#39;Young&#39;</span><span class="p">}}</span>

    <span class="k">return</span> <span class="n">GermanDataset</span><span class="p">(</span>
        <span class="n">label_name</span><span class="o">=</span><span class="n">Y_features</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">favorable_classes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">protected_attribute_names</span><span class="o">=</span><span class="n">D_features</span><span class="p">,</span>
        <span class="n">privileged_classes</span><span class="o">=</span><span class="p">[</span><span class="n">all_privileged_classes</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">D_features</span><span class="p">],</span>
        <span class="n">instance_weights_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">categorical_features</span><span class="o">=</span><span class="n">categorical_features</span><span class="p">,</span>
        <span class="n">features_to_keep</span><span class="o">=</span><span class="n">X_features</span><span class="o">+</span><span class="n">Y_features</span><span class="o">+</span><span class="n">D_features</span><span class="p">,</span>
        <span class="n">features_to_drop</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span> <span class="s1">&#39;label_maps&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;Good Credit&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">:</span> <span class="s1">&#39;Bad Credit&#39;</span><span class="p">}],</span>
                   <span class="s1">&#39;protected_attribute_maps&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">all_protected_attribute_maps</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">D_features</span><span class="p">]},</span>
        <span class="n">custom_preprocessing</span><span class="o">=</span><span class="n">custom_preprocessing</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/><br/></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Step 2: Explore and familiarize with the dataset</h3>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Q1: Analyse the dataset and answer the following:</b></p>
<ul>
<li>What is the number of records, </li>
<li>What is the number of attributes present with the preprocessing we provided, and </li>
<li>What is the list of attribute names.</li>
<li>Are there missing values that could create biases</li>
</ul>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-danger">
<b>Note:</b> If you encounted any errors in the following cell add the files &quot;german.doc&quot; and &quot;german.data&quot; to the folder <br/>
&quot;dist-packages/aif360/data/raw/german/&quot; under your python path you should get the same instructions in the error message.

You can find the files in Brightspace or download them from: <br/>
https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.data<br/>
https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.doc
    </div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Instanciating the German credit dataset</span>
<span class="n">dataset_gcredit</span> <span class="o">=</span> <span class="n">preproc_and_load_data_german</span><span class="p">()</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">
<b>Tip:</b> The documentation of &quot;AIF360 - German credit data&quot; dataset  can be found <a rel="noopener" href="https://aif360.readthedocs.io/en/latest/modules/generated/aif360.datasets.GermanDataset.html">[HERE]</a>. 


Take a look at documentation of AIF360 and use existing methods to explore the dataset instance how to access the features with:<br/> `dataset_gcredit.features`. 

You are also free to transform the dataset into a pandas dataframe to extract the needed information.
Use <br/>
    `pd_gdata = pd.DataFrame(dataset_gcredit.features, columns=dataset_gcredit.feature_names)` <br/>
    to create the pandas dataframe
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>-</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">### Answer by writing the code in this cell (or create more cells if needed):###</span>
<span class="c1"># Number of records:</span>

<span class="c1"># Number of features:</span>

<span class="c1"># Feature names:</span>

<span class="c1">#Number of missing values for each attribute</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/><br/></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Step 3: Identify protected attributes and proxies</h3>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Q2: Identification of protected attributes</b></p>
<p>a) Study the dataset and its documentation and identify which attributes that might raise unfairness concerns and should be considered protected (according to the law). Explain, in your opinion, why are these attributes protected provide exaples of bias or unfaireness for each identified attribute.</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><div class="alert alert-block alert-info">
<b>Tip:</b> 
Take a look at the following documents<br/>
<a rel="noopener" href="https://rm.coe.int/discrimination-artificial-intelligence-and-algorithmic-decision-making/1680925d73">(1) Discrimination, Artificial Intelligence, and Algorithmic Decision-Making (2018)</a><br/>
<a rel="noopener" href="http://ec.europa.eu/social/BlobServlet?docId=1691&amp;langId=en&amp;usg=AOvVaw3vI30bO3jisairH2Z7-nSl">(2) Age discrimination and European Law (2005)</a>.</div></p>
<div> 
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>-</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>b) Study the dataset and its documentation and identify any further &quot;non-protect&quot; attributes that could cause  unfairenesses. Explain your reasoning. provide examples of bias or unfairenesse related to each attribut.</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>-</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/><br/></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Q3:  Identification of &quot;spurious&quot; proxies</b></p>
<p>a) Find the proxies for the attribute &quot;sex&quot;.</p>
<p>b) Find proxies for one additional protected attribut you identified in Q2-a.</p>
<p>c) In your opinion, why do we want to identify proxies for protected attributes in a dataset? How should you handle the proxies?</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">
<b> Tip: </b>A proxy attribute <i>Ap</i>  is an attribute that has a similar distribution as another attribute <i>Ax</i>, so having access to the proxy attribute <i>Ap</i> provides a good knowledge of the other attribute <i>Ax</i>. For instance, in the US the zipcode is a powerful proxy for race and education, the zipcode combined with websites visited is an even more powerful proxy, names in certain languages are strong proxies for gender, etc.<br/>

The simplest way to identify proxy attributes for a protected attribute <i>Ax</i> is to compute the correlation of <i>Ax</i>  with each other attributes in the dataset. The higher the corrolation the higher the likelihood an attribute is a proxy of <i>Ax</i> <br/>

You can use the `corr()` function of the pandas library to compute the correlation between two attributes
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/>
<b>Q4: Data skews and Representation biases</b></p>
<p>a) Is the dataset we are working with representative of the German population with regard to age. <br/>
Add any needed code or analysis to briefely justify your answer<br/></p>
<p>b) Is the dataset we are working with representative of the German population with regard to gender. <br/>
Add any needed code or analysis to briefely justify your answer</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">
<b> Tip: </b> You can find demographic information from Wikipedia <a rel="noopener" href="https://en.wikipedia.org/wiki/Demographics_of_Germany">[Here]</a>

Go to section <b><i>Demographic statistics</i></b> take a closer look at the most racent  <b><i>Age structure</i></b> data (it should be from 2018). Use this data to build a distribution of german population across age, then across gender and compare it to the distributions from <b><i>the German credit data</i></b> we are working with.

It is up to you how you want to justify your answer, however using visualizations will provide more points (i.e., plots and diagram)
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Answer with the code here </span>
<span class="c1"># No code is required however it will make your reasening clearer to the assessor </span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>-</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Q5: Data skews</b></p>
<p>Is there a skew towards certain groups:<br/>
a) Analyse the dataset, and report the numbers of male / female with bad/good credit. Do the same for &quot;old&quot; / &quot; young&quot; people in the datset. Normalize these numbers respectively over the total number of males/females, &quot;old&quot;/&quot;young&quot; for a fair comparison. For that, you can consider having 50 individuals for each of these groups.</p>
<p>b) Brieflt describe your findings and explain the impacts (on faireness) of using this dataset as training data (if any)</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">
<b> Tip: </b> We provide a function for Normalised count per attribut and lable you are free to use it or implement your own method 

`getNormalizedCount()`
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Normalised count per attribut and lable </span>
<span class="k">def</span> <span class="nf">getNormalizedCount</span><span class="p">(</span><span class="n">pd_train_data</span><span class="p">,</span> <span class="n">protected_attribute</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">unnormalized_count</span> <span class="o">=</span> <span class="n">pd_train_data</span><span class="p">[[</span><span class="n">protected_attribute</span><span class="p">,</span> <span class="n">label</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">attribute_value</span> <span class="ow">in</span> <span class="n">pd_train_data</span><span class="p">[[</span><span class="n">protected_attribute</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">counts</span><span class="p">[</span><span class="n">attribute_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pd_train_data</span><span class="p">[[</span><span class="n">protected_attribute</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="n">attribute_value</span><span class="p">]</span>
    <span class="n">normalized_count</span> <span class="o">=</span> <span class="n">unnormalized_count</span><span class="p">[:]</span>
    <span class="k">for</span> <span class="n">attribute_value</span><span class="p">,</span> <span class="n">credit_value</span> <span class="ow">in</span> <span class="n">pd_train_data</span><span class="p">[[</span><span class="n">protected_attribute</span><span class="p">,</span> <span class="n">label</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">normalized_count</span><span class="p">[</span><span class="n">attribute_value</span><span class="p">,</span> <span class="n">credit_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_count</span><span class="p">[</span><span class="n">attribute_value</span><span class="p">,</span> <span class="n">credit_value</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">50</span> <span class="o">/</span> <span class="n">counts</span><span class="p">[</span><span class="n">attribute_value</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">normalized_count</span>

<span class="c1"># add the credit labels to the data set.</span>
<span class="n">pd_gdata</span><span class="p">[</span><span class="s2">&quot;credit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset_gcredit</span><span class="o">.</span><span class="n">labels</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">### YOUR ANSWER HERE ###</span>
<span class="c1"># ADD code here to print the AGE-CREDIT distribution</span>


<span class="c1"># ADD code here to print the SEX-CREDIT distribution</span>


<span class="c1"># ADD code here to visualise the results for both you can use stacked bar plots from pandas toolkit</span>
<span class="c1">#&lt;your dataframe&gt;.size().unstack().plot(kind=&#39;bar&#39;, stacked=True)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>-</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/><br/></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3> Step 4: In-Prosessing Biases </h3>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Q6: We will apply in-processing mitigation technique to alliviate the <i>age</i> biase in the German credit data</b></p>
<p>a) Set the privilege and unprivilaged age group based on the findings of question Q5-a (answer in the text then add the variables 0 or 1 to the code below). Provide a very brief justification for your answer</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>-</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Add the code for question a) here</span>
<span class="c1"># code = 1: is old above 25</span>
<span class="c1"># code = 0: is young under 25</span>

<span class="n">privileged_code</span> <span class="o">=</span> <span class="c1">#add the write code here</span>
<span class="n">unprivileged_code</span> <span class="o">=</span> <span class="c1">#add the write code here</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># We start by defining the privilaged and unprivileged </span>
<span class="n">privileged_groups</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">privileged_code</span><span class="p">}]</span> 
<span class="n">unprivileged_groups</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">unprivileged_code</span><span class="p">}]</span> 
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Preparation for training a classifier.</b><br/>
We will  divide the dataset into a training and a test subsets.
We define them respectively as 70% and 30% of the whole data.
We will use the following code to do so.</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">dataset_gcredit_train</span><span class="p">,</span> <span class="n">dataset_gcredit_test</span> <span class="o">=</span> \
    <span class="n">dataset_gcredit</span><span class="o">.</span><span class="n">split</span><span class="p">([</span><span class="mf">0.7</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Faireness before mitigation</b><br/>
Below we are using several faireness metrics from AIF360 toolkint to evaluate fairenesse metrics before appling the inprocessing mitigation</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">metric_orig_train</span> <span class="o">=</span> <span class="n">BinaryLabelDatasetMetric</span><span class="p">(</span><span class="n">dataset_gcredit_train</span><span class="p">,</span> 
                                             <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                             <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train set: Difference in mean outcomes between unprivileged and privileged groups = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric_orig_train</span><span class="o">.</span><span class="n">mean_difference</span><span class="p">()))</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Get classifier without fairness constraints</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">biased_model</span> <span class="o">=</span> <span class="n">MetaFairClassifier</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sensitive_attr</span><span class="o">=</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;fdr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset_gcredit_train</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Apply the unconstrained model to test data</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">dataset_bias_test</span> <span class="o">=</span> <span class="n">biased_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset_gcredit_test</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Build and test the &quot;biased&quot; classifier</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">classified_metric_bias_test</span> <span class="o">=</span> <span class="n">ClassificationMetric</span><span class="p">(</span><span class="n">dataset_gcredit_test</span><span class="p">,</span> <span class="n">dataset_bias_test</span><span class="p">,</span>
                                                   <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                                   <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set: Classification accuracy = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">classified_metric_bias_test</span><span class="o">.</span><span class="n">accuracy</span><span class="p">()))</span>
<span class="n">TPR</span> <span class="o">=</span> <span class="n">classified_metric_bias_test</span><span class="o">.</span><span class="n">true_positive_rate</span><span class="p">()</span>
<span class="n">TNR</span> <span class="o">=</span> <span class="n">classified_metric_bias_test</span><span class="o">.</span><span class="n">true_negative_rate</span><span class="p">()</span>
<span class="n">bal_acc_bias_test</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">TPR</span><span class="o">+</span><span class="n">TNR</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set: Balanced classification accuracy = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bal_acc_bias_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set: Disparate impact = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">classified_metric_bias_test</span><span class="o">.</span><span class="n">disparate_impact</span><span class="p">()))</span>
<span class="n">fdr</span> <span class="o">=</span> <span class="n">classified_metric_bias_test</span><span class="o">.</span><span class="n">false_discovery_rate_ratio</span><span class="p">()</span>
<span class="n">fdr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fdr</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fdr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set: False discovery rate ratio = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fdr</span><span class="p">))</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/>
<b> Q6 -</b>
b) Run the code above and explain the results: briefly describe each metrics and the interpretation of the values.</p>
<p>Metrics:<br/></p>
<ul>
<li>Difference in mean outcomes between unprivileged and privileged groups</li>
<li>Classification accuracy</li>
<li>Balanced classification accuracy</li>
<li>Disparate impact</li>
<li>False discovery rate ratio</li>
</ul>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">
<b> Tip: </b> Make use of the documentation of <a rel="noopener" href="https://aif360.readthedocs.io/en/latest/index.html"><b>AIF360</b></a>, and your own search to understaind the metrics and to be able to interpret them.
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>-</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b> Train a debiased classifier </b><br/>
In the following we will apply an in-processing debiasin technique <b><i>&quot;Meta-Algorithm for fair classification&quot;</i></b>. This debiesing technique operates with a faireness constraint i.e., by optimising for faireness metrics. You can read more about it <a rel="noopener" href="https://arxiv.org/pdf/1806.06055.pdf">[HERE]</a><br/>
For this example we will to optimize for the <i><b> the fals discovery rate (fdr)</b></i> and sensitive attribute <i><b> age </b></i></p>
<p>Apply the debiased model to training data and train the <b><i>&quot;debiased&quot;</i></b> classifier</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">debiased_model</span> <span class="o">=</span> <span class="n">MetaFairClassifier</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">sensitive_attr</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;fdr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset_gcredit_train</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Apply the debiased classifier to test data</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">dataset_debiasing_test</span> <span class="o">=</span> <span class="n">debiased_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset_gcredit_test</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Compute the same faireness metrics for the <b><i>&quot;debiased&quot;</i></b> data and classifier</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">metric_dataset_debiasing_test</span> <span class="o">=</span> <span class="n">BinaryLabelDatasetMetric</span><span class="p">(</span><span class="n">dataset_debiasing_test</span><span class="p">,</span> 
                                             <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                             <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set: Difference in mean outcomes between unprivileged and privileged groups = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric_dataset_debiasing_test</span><span class="o">.</span><span class="n">mean_difference</span><span class="p">()))</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">classified_metric_debiasing_test</span> <span class="o">=</span> <span class="n">ClassificationMetric</span><span class="p">(</span><span class="n">dataset_gcredit_test</span><span class="p">,</span> 
                                                 <span class="n">dataset_debiasing_test</span><span class="p">,</span>
                                                 <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                                 <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set: Classification accuracy = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">classified_metric_debiasing_test</span><span class="o">.</span><span class="n">accuracy</span><span class="p">()))</span>
<span class="n">TPR</span> <span class="o">=</span> <span class="n">classified_metric_debiasing_test</span><span class="o">.</span><span class="n">true_positive_rate</span><span class="p">()</span>
<span class="n">TNR</span> <span class="o">=</span> <span class="n">classified_metric_debiasing_test</span><span class="o">.</span><span class="n">true_negative_rate</span><span class="p">()</span>
<span class="n">bal_acc_debiasing_test</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">TPR</span><span class="o">+</span><span class="n">TNR</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set: Balanced classification accuracy = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bal_acc_debiasing_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set: Disparate impact = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">classified_metric_debiasing_test</span><span class="o">.</span><span class="n">disparate_impact</span><span class="p">()))</span>
<span class="n">fdr</span> <span class="o">=</span> <span class="n">classified_metric_debiasing_test</span><span class="o">.</span><span class="n">false_discovery_rate_ratio</span><span class="p">()</span>
<span class="n">fdr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fdr</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fdr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set: False discovery rate ratio = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fdr</span><span class="p">))</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/>
<b> Q6 -</b>
c) Run the code above and compare the results between the <b><i>&quot;debiased&quot;</i></b> and the <b><i>&quot;biased&quot;</i></b> classifiers</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">
<b> Tip: </b> Focus on <b>FDR</b>, <b>Accuracy</b> and <b>Difference in mean outcomes</b>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>-</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/><br/></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><h2> Part III. Explainability</h2>
<i>LO-4. Compare different implementations of fairness metrics and unfairness mitigation approaches.  
</i></p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>In this last part we will use the same scenario from Part II. To explore LIME Local Interpretable Model-Agnostic Explanations.</p>

</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#Train model on german credit data dataset</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_gcredit_train</span>  <span class="c1"># data to train on</span>

<span class="n">scale</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>   <span class="c1"># remember the scale</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>        <span class="c1"># model to learn</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>      <span class="c1">#apply the scale</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>


<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">instance_weights</span><span class="p">)</span>

<span class="c1">#save model</span>
<span class="n">lr_orig</span> <span class="o">=</span> <span class="n">model</span>
<span class="n">lr_scale_orig</span> <span class="o">=</span> <span class="n">scale</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#Test model on given dataset and find threshold for best balanced accuracy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="n">thresh_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">scale</span> <span class="o">=</span> <span class="n">lr_scale_orig</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">lr_orig</span>                  <span class="c1">#model to test</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_gcredit_test</span>        <span class="c1">#data to test on</span>

<span class="n">X_test</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>   <span class="c1">#apply the same scale as applied to the training data</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">y_test_pred_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>


<span class="n">bal_acc_arr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">disp_imp_arr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">avg_odds_diff_arr</span> <span class="o">=</span> <span class="p">[]</span>
    
<span class="k">for</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">thresh_arr</span><span class="p">):</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_test_pred_prob</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">dataset_pred</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dataset_pred</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">y_test_pred</span>

    <span class="n">classified_metric</span> <span class="o">=</span> <span class="n">ClassificationMetric</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> 
                                                 <span class="n">dataset_pred</span><span class="p">,</span>
                                                 <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                                 <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span><span class="p">)</span>
    <span class="n">metric_pred</span> <span class="o">=</span> <span class="n">BinaryLabelDatasetMetric</span><span class="p">(</span><span class="n">dataset_pred</span><span class="p">,</span>
                                                 <span class="n">unprivileged_groups</span><span class="o">=</span><span class="n">unprivileged_groups</span><span class="p">,</span>
                                                 <span class="n">privileged_groups</span><span class="o">=</span><span class="n">privileged_groups</span><span class="p">)</span>
    
    <span class="n">TPR</span> <span class="o">=</span> <span class="n">classified_metric</span><span class="o">.</span><span class="n">true_positive_rate</span><span class="p">()</span>
    <span class="n">TNR</span> <span class="o">=</span> <span class="n">classified_metric</span><span class="o">.</span><span class="n">true_negative_rate</span><span class="p">()</span>
    <span class="n">bal_acc</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">TPR</span><span class="o">+</span><span class="n">TNR</span><span class="p">)</span>
    
    <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                            <span class="n">y_pred</span><span class="o">=</span><span class="n">dataset_pred</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">bal_acc_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bal_acc</span><span class="p">)</span>
    <span class="n">avg_odds_diff_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classified_metric</span><span class="o">.</span><span class="n">average_odds_difference</span><span class="p">())</span>
    <span class="n">disp_imp_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_pred</span><span class="o">.</span><span class="n">disparate_impact</span><span class="p">())</span>
    
<span class="n">thresh_arr_best_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bal_acc_arr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bal_acc_arr</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">thresh_arr_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thresh_arr</span><span class="p">)[</span><span class="n">thresh_arr_best_ind</span><span class="p">]</span>

<span class="n">best_bal_acc</span> <span class="o">=</span> <span class="n">bal_acc_arr</span><span class="p">[</span><span class="n">thresh_arr_best_ind</span><span class="p">]</span>
<span class="n">disp_imp_at_best_bal_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">disp_imp_arr</span><span class="p">))[</span><span class="n">thresh_arr_best_ind</span><span class="p">]</span>

<span class="n">avg_odds_diff_at_best_bal_acc</span> <span class="o">=</span> <span class="n">avg_odds_diff_arr</span><span class="p">[</span><span class="n">thresh_arr_best_ind</span><span class="p">]</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">limeData</span> <span class="o">=</span> <span class="n">LimeEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset_gcredit_train</span><span class="p">)</span>
<span class="n">s_train</span> <span class="o">=</span> <span class="n">limeData</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dataset_gcredit_train</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
<span class="n">s_test</span> <span class="o">=</span> <span class="n">limeData</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dataset_gcredit_test</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>

<span class="n">scale</span> <span class="o">=</span> <span class="n">lr_scale_orig</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">lr_orig</span>                  <span class="c1">#model to test</span>




<span class="n">explainer</span> <span class="o">=</span> <span class="n">lime</span><span class="o">.</span><span class="n">lime_tabular</span><span class="o">.</span><span class="n">LimeTabularExplainer</span><span class="p">(</span><span class="n">s_train</span> <span class="p">,</span><span class="n">class_names</span><span class="o">=</span><span class="n">limeData</span><span class="o">.</span><span class="n">s_class_names</span><span class="p">,</span> 
                                                   <span class="n">feature_names</span> <span class="o">=</span> <span class="n">limeData</span><span class="o">.</span><span class="n">s_feature_names</span><span class="p">,</span>
                                                   <span class="n">categorical_features</span><span class="o">=</span><span class="n">limeData</span><span class="o">.</span><span class="n">s_categorical_features</span><span class="p">,</span> 
                                                   <span class="n">categorical_names</span><span class="o">=</span><span class="n">limeData</span><span class="o">.</span><span class="n">s_categorical_names</span><span class="p">,</span> 
                                                   <span class="n">kernel_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">discretize_continuous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">s_predict_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">limeData</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><br/>
<b>Q7: Using LIME </b> <br/>
a) Provide a short definition of LIME and what it is used for.</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">
<b> Tip: </b> Information about LIME can be found <a rel="noopener" href="https://arxiv.org/pdf/1602.04938.pdf"> [HERE] </a>
</div>
</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>-</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Q7 - </b>
b) Select two loan applications form the test data set (One classified as &quot;Good Credit&quot; and one &quot;Bad Credit&quot;). Get the decision explaned by Lime.</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<div class="alert alert-block alert-info">
<b> Tip: </b>Use the following code to explain the classifier decision and print/plot the results from LIME

`i = # the index of the test data entry goes here
exp = explainer.explain_instance(s_test[i], s_predict_fn, num_features=5)
exp.as_pyplot_figure()
print(&quot;        Actual label: &quot; + str(dataset_gcredit_test.labels[i]))`


</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Good Credit explanation</span>
<span class="c1"># Answer with the code here</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Bad Credit explanation</span>
<span class="c1"># Answer with the code here</span>
</pre></div>

     </div>
</div>
</div>
</div>

</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><b>Q7 - </b>
c) Describe and explaine the results from lime for each of the decisions (Output of Q7-b)</p>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<ul>
<li>Explain a &quot;Bad Credit&quot; decision explanation here</li>
</ul>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<ul>
<li>Explain a &quot;Good Credit&quot; decision explanation here</li>
</ul>

</div>
</div>
<div class="jp-Cell-inputWrapper"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p><h3> --------- And of the assignment ---------</h3><br/>
<i>We hope that you enjoyed this lecture.<br/> Nadia &amp; Ibo</i></p><i>

</i></div><i>
</i></div><i><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
     <div class="CodeMirror cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span> 
</pre></div>

     </div>
</div>
</div>
</div>

</div>
</i></div></i></i><i><i>







</i></i><i><i>
</i></i><script type="text/javascript" src="/d2l/common/math/MathML.js?v=20.21.8.31671 "></script><script type="text/javascript">document.addEventListener('DOMContentLoaded', function() { D2LMathML.DesktopInit('https://s.brightspace.com/lib/mathjax/2.7.4/MathJax.js?config=MML_HTMLorMML','https://s.brightspace.com/lib/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML','130',true); });</script></body></html>